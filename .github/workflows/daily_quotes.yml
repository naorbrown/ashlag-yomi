name: Send Daily Quotes

on:
  schedule:
    # Run at 6:00 AM Israel time (IST is UTC+2, or UTC+3 during DST)
    # Israel observes DST from last Friday before April 2 to last Sunday of October
    - cron: '0 3 * * *'  # 6:00 AM Israel (DST - summer)
    - cron: '0 4 * * *'  # 6:00 AM Israel (Standard time - winter)

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (preview only, no send)'
        required: false
        default: 'false'
        type: boolean
      force_send:
        description: 'Force send regardless of time check'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  send-quotes:
    name: Send Daily Quotes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check Israel Time
        id: check-time
        run: |
          ISRAEL_HOUR=$(TZ='Asia/Jerusalem' date +%H)
          ISRAEL_DATE=$(TZ='Asia/Jerusalem' date +%Y-%m-%d)
          echo "israel_hour=$ISRAEL_HOUR" >> $GITHUB_OUTPUT
          echo "israel_date=$ISRAEL_DATE" >> $GITHUB_OUTPUT
          echo "üìÖ Israel Date: $ISRAEL_DATE"
          echo "üïê Israel Hour: $ISRAEL_HOUR"

          # Proceed if 6am OR manual trigger with force
          if [ "$ISRAEL_HOUR" = "06" ] || \
             [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Proceeding with quote delivery"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping - not 6am Israel time (current: $ISRAEL_HOUR)"
          fi

      - name: Checkout repository
        if: steps.check-time.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check-time.outputs.proceed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        if: steps.check-time.outputs.proceed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install python-telegram-bot>=20.7 python-dotenv

      - name: Validate quotes before sending
        if: steps.check-time.outputs.proceed == 'true'
        run: |
          python << 'EOFPY'
          from src.quote_manager import QuoteManager

          qm = QuoteManager()
          quotes = qm.get_daily_quotes()

          print(f"üìä Validating {len(quotes)} quotes for today...")

          for quote in quotes:
              # Check required fields
              assert quote.get('text'), f"Empty text in {quote.get('id')}"
              assert quote.get('source'), f"Missing source in {quote.get('id')}"
              print(f"  ‚úÖ {quote.get('source_name', 'Unknown')}: {len(quote['text'])} chars")

          print(f"\n‚úÖ All {len(quotes)} quotes validated successfully")
          EOFPY

      - name: Preview daily message (Test Mode)
        if: steps.check-time.outputs.proceed == 'true' && github.event.inputs.test_mode == 'true'
        run: |
          python << 'EOFPY'
          from src.quote_manager import QuoteManager
          from datetime import date

          qm = QuoteManager()
          stats = qm.get_stats()

          print("=" * 50)
          print("üìñ ASHLAG YOMI - TEST MODE PREVIEW")
          print("=" * 50)
          print(f"üìÖ Date: {date.today().strftime('%Y-%m-%d')}")
          print(f"üìä Total quotes in database: {stats['total']}")
          print()

          print("Today's quotes:")
          print("-" * 50)
          for quote in qm.get_daily_quotes():
              quality = qm.evaluate_quote_quality(quote)
              print(f"\n‚ú® {quote.get('source_name')}")
              print(f"   ¬´{quote['text'][:80]}{'...' if len(quote['text']) > 80 else ''}¬ª")
              print(f"   üìà Quality: {quality.grade} ({quality.total_score}/25)")

          print("\n" + "=" * 50)
          print("‚úÖ Test complete - no message sent")
          EOFPY

      - name: Send daily quotes
        if: >
          steps.check-time.outputs.proceed == 'true' &&
          github.event.inputs.test_mode != 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Retry logic with exponential backoff
          MAX_RETRIES=3
          RETRY_DELAY=5

          for i in $(seq 1 $MAX_RETRIES); do
            echo "üöÄ Attempt $i of $MAX_RETRIES..."
            if python send_daily.py; then
              echo "‚úÖ Daily quotes sent successfully!"
              exit 0
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Attempt $i failed, retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "‚ùå All $MAX_RETRIES attempts failed"
                exit 1
              fi
            fi
          done

      - name: Log completion
        if: always() && steps.check-time.outputs.proceed == 'true'
        run: |
          echo "üìã Workflow Summary"
          echo "  Date (Israel): ${{ steps.check-time.outputs.israel_date }}"
          echo "  Hour (Israel): ${{ steps.check-time.outputs.israel_hour }}"
          echo "  Test Mode: ${{ github.event.inputs.test_mode || 'false' }}"
          echo "  Trigger: ${{ github.event_name }}"
