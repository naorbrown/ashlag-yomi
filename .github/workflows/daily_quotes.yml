name: Send Daily Quotes

on:
  schedule:
    # Run at 6:00 AM Israel time (IST is UTC+2, or UTC+3 during DST)
    # Using 4:00 AM UTC to account for standard time (3:00 AM UTC for DST)
    # Israel observes DST from last Friday before April 2 to last Sunday of October
    - cron: '0 3 * * *'  # 6:00 AM Israel (DST - most of the year)
    - cron: '0 4 * * *'  # 6:00 AM Israel (Standard time - winter)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no actual send)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  send-quotes:
    runs-on: ubuntu-latest
    
    # Only run once - check if it's actually 6am Israel time
    steps:
      - name: Check Israel Time
        id: check-time
        run: |
          # Get current hour in Israel timezone
          ISRAEL_HOUR=$(TZ='Asia/Jerusalem' date +%H)
          echo "Current Israel hour: $ISRAEL_HOUR"
          
          # Only proceed if it's 6am (allowing some flexibility)
          if [ "$ISRAEL_HOUR" = "06" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "Skipping - not 6am Israel time"
          fi
      
      - name: Checkout repository
        if: steps.check-time.outputs.proceed == 'true'
        uses: actions/checkout@v4
      
      - name: Set up Python
        if: steps.check-time.outputs.proceed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.check-time.outputs.proceed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install python-telegram-bot>=20.7
      
      - name: Send daily quotes
        if: steps.check-time.outputs.proceed == 'true' && github.event.inputs.test_mode != 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python send_daily.py
      
      - name: Test mode - validate only
        if: steps.check-time.outputs.proceed == 'true' && github.event.inputs.test_mode == 'true'
        run: |
          python -c "
          from src.quote_manager import QuoteManager
          qm = QuoteManager()
          stats = qm.get_stats()
          print('Quote Statistics:')
          for source, count in stats['by_source'].items():
              print(f'  {source}: {count} quotes')
          print(f'Total: {stats[\"total\"]} quotes')
          
          print('\nDaily message preview:')
          print(qm.format_daily_message()[:500] + '...')
          "
