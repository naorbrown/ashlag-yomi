name: Daily Quotes

on:
  schedule:
    # 6:00 AM Israel time (UTC+2 winter, UTC+3 summer)
    - cron: '0 3 * * *'  # 6 AM during DST (summer)
    - cron: '0 4 * * *'  # 6 AM during standard time (winter)

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Preview only (no send)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  send-quotes:
    name: Send Daily Quotes
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check Israel time
        id: time
        run: |
          HOUR=$(TZ='Asia/Jerusalem' date +%H)
          DATE=$(TZ='Asia/Jerusalem' date +%Y-%m-%d)
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Israel: $DATE $HOUR:00"

          if [ "$HOUR" = "06" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "Skipping - not 6 AM Israel time"
          fi

      - name: Checkout
        if: steps.time.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.time.outputs.proceed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        if: steps.time.outputs.proceed == 'true'
        run: |
          pip install --upgrade pip
          pip install python-telegram-bot>=20.7

      - name: Validate quotes
        if: steps.time.outputs.proceed == 'true'
        run: |
          python << 'EOFPY'
          from src.quote_manager import QuoteManager

          qm = QuoteManager()
          quotes = qm.get_daily_quotes()

          print(f"Validating {len(quotes)} quotes...")
          for q in quotes:
              assert q.get('text'), f"Empty text: {q.get('id')}"
              assert q.get('source'), f"Missing source: {q.get('id')}"
              print(f"  {q.get('source_name')}: OK")

          print(f"All {len(quotes)} quotes validated")
          EOFPY

      - name: Preview (test mode)
        if: steps.time.outputs.proceed == 'true' && github.event.inputs.test_mode == 'true'
        run: |
          python << 'EOFPY'
          from src.quote_manager import QuoteManager
          from datetime import date

          qm = QuoteManager()
          print("=" * 40)
          print("PREVIEW - Test Mode")
          print(f"Date: {date.today()}")
          print("=" * 40)

          for q in qm.get_daily_quotes():
              print(f"\n{q.get('source_name')}")
              print(f"  {q['text'][:60]}...")
              print(f"  Source: {q['source']}")

          print("\n" + "=" * 40)
          print("Preview complete - no message sent")
          EOFPY

      - name: Send quotes
        if: steps.time.outputs.proceed == 'true' && github.event.inputs.test_mode != 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          for i in 1 2 3; do
            echo "Attempt $i..."
            if python send_daily.py; then
              echo "Success"
              exit 0
            fi
            [ $i -lt 3 ] && sleep $((i * 5))
          done
          echo "Failed after 3 attempts"
          exit 1

      - name: Summary
        if: always() && steps.time.outputs.proceed == 'true'
        run: |
          echo "Date: ${{ steps.time.outputs.date }}"
          echo "Hour: ${{ steps.time.outputs.hour }}"
          echo "Test mode: ${{ github.event.inputs.test_mode || 'false' }}"
