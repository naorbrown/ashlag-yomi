name: CI

on:
  push:
    branches: [main, claude/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with ruff
        run: ruff check src/ tests/ --ignore E501

      - name: Type check with mypy
        run: mypy src/ --ignore-missing-imports
        continue-on-error: true

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest tests/ -v

  validate-data:
    name: Data Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate JSON syntax
        run: |
          echo "Validating JSON files..."
          for f in data/quotes/*.json; do
            python -m json.tool "$f" > /dev/null || { echo "Invalid JSON: $f"; exit 1; }
            echo "Valid: $f"
          done

      - name: Validate quote structure
        run: |
          python << 'EOFPY'
          import json
          import re
          from pathlib import Path

          REQUIRED_FIELDS = ['id', 'text', 'source', 'source_url']
          HEBREW_PATTERN = re.compile(r'[\u0590-\u05FF]')

          quotes_dir = Path('data/quotes')
          errors = []
          total = 0

          for json_file in sorted(quotes_dir.glob('*.json')):
              with open(json_file, 'r', encoding='utf-8') as f:
                  data = json.load(f)

              if 'source_name' not in data:
                  errors.append(f"{json_file.name}: Missing 'source_name'")

              for quote in data.get('quotes', []):
                  total += 1
                  quote_id = quote.get('id', 'unknown')

                  for field in REQUIRED_FIELDS:
                      if field not in quote:
                          errors.append(f"{json_file.name}:{quote_id}: Missing '{field}'")

                  if not HEBREW_PATTERN.search(quote.get('text', '')):
                      errors.append(f"{json_file.name}:{quote_id}: No Hebrew text")

          print(f"Validated {total} quotes from {len(list(quotes_dir.glob('*.json')))} sources")

          if errors:
              for e in errors:
                  print(f"Error: {e}")
              exit(1)

          print("All validations passed")
          EOFPY

      - name: Test deterministic selection
        run: |
          python << 'EOFPY'
          import sys
          sys.path.insert(0, '.')
          from src.quote_manager import QuoteManager

          qm = QuoteManager()
          quotes1 = qm.get_daily_quotes()
          quotes2 = qm.get_daily_quotes()

          for q1, q2 in zip(quotes1, quotes2):
              assert q1['id'] == q2['id'], "Determinism check failed"

          print(f"Deterministic selection verified for {len(quotes1)} quotes")
          EOFPY

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          if grep -rE "(api[_-]?key|secret|token|password)\s*=\s*['\"][A-Za-z0-9+/=]{20,}['\"]" \
             --include="*.py" --include="*.json" --exclude-dir=.git .; then
            echo "Potential secrets found"
            exit 1
          fi
          echo "No hardcoded secrets detected"

      - name: Check sensitive files
        run: |
          for f in .env .env.local *.pem *.key credentials.json; do
            if [ -f "$f" ]; then
              echo "Sensitive file found: $f"
              exit 1
            fi
          done
          echo "No sensitive files in repository"
