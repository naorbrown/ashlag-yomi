# Continuous Integration Workflow
# Runs tests, linting, and type checking on all PRs and pushes

name: CI

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main, master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff linter
        run: ruff check src/ tests/ --output-format=github

      - name: Run Ruff formatter check
        run: ruff format src/ tests/ --check

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run MyPy
        run: mypy src/ --ignore-missing-imports --no-error-summary || true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  validate-quotes:
    name: Validate Quotes Database
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate JSON files
        run: |
          python -c "
          import json
          from pathlib import Path

          errors = []
          quotes_dir = Path('data/quotes')

          for f in quotes_dir.glob('*.json'):
              try:
                  with open(f, encoding='utf-8') as file:
                      data = json.load(file)

                  if f.name == 'metadata.json':
                      continue

                  if 'quotes' not in data:
                      errors.append(f'{f.name}: missing quotes array')
                      continue

                  if len(data['quotes']) == 0:
                      errors.append(f'{f.name}: empty quotes array')
                      continue

                  for i, quote in enumerate(data['quotes']):
                      if 'text' not in quote:
                          errors.append(f'{f.name}[{i}]: missing text')
                      if 'source' not in quote:
                          errors.append(f'{f.name}[{i}]: missing source')

              except json.JSONDecodeError as e:
                  errors.append(f'{f.name}: invalid JSON - {e}')

          if errors:
              for e in errors:
                  print(f'ERROR: {e}')
              exit(1)
          else:
              print('All quote files validated successfully!')
          "

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run security scan
        run: |
          # Check for common security issues
          echo "Checking for hardcoded secrets..."
          if grep -rn "TELEGRAM_BOT_TOKEN\s*=" --include="*.py" src/ 2>/dev/null | grep -v "os.environ"; then
            echo "WARNING: Possible hardcoded token found"
            exit 1
          fi
          echo "No hardcoded secrets found"

          echo "Checking for sensitive files..."
          if [ -f ".env" ]; then
            echo "WARNING: .env file found in repository"
            exit 1
          fi
          echo "No sensitive files found"
