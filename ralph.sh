#!/bin/bash
# Ralph Wiggum - AI Loop Technique for Claude Code
# "I'm helping!" - Ralph Wiggum
#
# Usage: ./ralph.sh [options] "Your task description"

set -e

# Default configuration
MAX_ITERATIONS=50
COMPLETION_PROMISE="COMPLETE"
PROMPT_FILE=""
WORKING_DIR="."
MODEL=""
VERBOSE=false
DRY_RUN=false
TASK_PROMPT=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
            --max-iterations)
                        MAX_ITERATIONS="$2"
                                    shift 2
                                                ;;
                                                        --completion-promise)
                                                                    COMPLETION_PROMISE="$2"
                                                                                shift 2
                                                                                            ;;
                                                                                                    --prompt-file)
                                                                                                                PROMPT_FILE="$2"
                                                                                                                            shift 2
                                                                                                                                        ;;
                                                                                                                                                --working-dir)
                                                                                                                                                            WORKING_DIR="$2"
                                                                                                                                                                        shift 2
                                                                                                                                                                                    ;;
                                                                                                                                                                                            --model)
                                                                                                                                                                                                        MODEL="$2"
                                                                                                                                                                                                                    shift 2
                                                                                                                                                                                                                                ;;
                                                                                                                                                                                                                                        --verbose)
                                                                                                                                                                                                                                                    VERBOSE=true
                                                                                                                                                                                                                                                                shift
                                                                                                                                                                                                                                                                            ;;
                                                                                                                                                                                                                                                                                    --dry-run)
                                                                                                                                                                                                                                                                                                DRY_RUN=true
                                                                                                                                                                                                                                                                                                            shift
                                                                                                                                                                                                                                                                                                                        ;;
                                                                                                                                                                                                                                                                                                                                --help|-h)
                                                                                                                                                                                                                                                                                                                                            echo "Ralph Wiggum - AI Loop Technique for Claude Code"
                                                                                                                                                                                                                                                                                                                                                        echo ""
                                                                                                                                                                                                                                                                                                                                                                    echo "Usage: $0 [options] \"Your task description\""
                                                                                                                                                                                                                                                                                                                                                                                echo ""
                                                                                                                                                                                                                                                                                                                                                                                            echo "Options:"
                                                                                                                                                                                                                                                                                                                                                                                                        echo "  --max-iterations N       Stop after N iterations (default: 50)"
                                                                                                                                                                                                                                                                                                                                                                                                                    echo "  --completion-promise STR Phrase signaling completion (default: COMPLETE)"
                                                                                                                                                                                                                                                                                                                                                                                                                                echo "  --prompt-file FILE       Use file as prompt instead of argument"
                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "  --working-dir DIR        Set working directory (default: current)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "  --model MODEL            Specify model (sonnet, opus, haiku)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "  --verbose                Show iteration progress"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "  --dry-run                Show command without running"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "  --help                   Show this help message"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        TASK_PROMPT="$1"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    shift
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                #!/bin/bash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Ralph Wiggum - AI Loop Technique for Claude Code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # "I'm helping!" - Ralph Wiggum
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                #
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Usage: ./ralph.sh [options] "Your task description"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                set -e
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Default configuration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                MAX_ITERATIONS=50
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                COMPLETION_PROMISE="COMPLETE"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PROMPT_FILE=""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WORKING_DIR="."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                MODEL=""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                VERBOSE=false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DRY_RUN=false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                TASK_PROMPT=""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Colors for output
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                RED='\033[0;31m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                GREEN='\033[0;32m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                YELLOW='\033[1;33m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                BLUE='\033[0;34m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PURPLE='\033[0;35m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NC='\033[0m'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Parse command line arguments
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                while [[ $# -gt 0 ]]; do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    case $1 in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            --max-iterations)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MAX_ITERATIONS="$2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    shift 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        --completion-promise)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    COMPLETION_PROMISE="$2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                shift 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    --prompt-file)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PROMPT_FILE="$2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            shift 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                --working-dir)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            WORKING_DIR="$2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        shift 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            --model)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MODEL="$2"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    shift 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        --verbose)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    VERBOSE=true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                shift
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    --dry-run)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DRY_RUN=true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            shift
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                --help|-h)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "Ralph Wiggum - AI Loop Technique for Claude Code"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "Usage: $0 [options] \"Your task description\""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "Options:"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "  --max-iterations N       Stop after N iterations (default: 50)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "  --completion-promise STR Phrase signaling completion (default: COMPLETE)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "  --prompt-file FILE       Use file as prompt instead of argument"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "  --working-dir DIR        Set working directory (default: current)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "  --model MODEL            Specify model (sonnet, opus, haiku)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "  --verbose                Show iteration progress"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "  --dry-run                Show command without running"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "  --help                   Show this help message"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        TASK_PROMPT="$1"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    shift
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ;;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    esac
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    get_prompt() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [[ -n "$PROMPT_FILE" ]] && [[ -f "$PROMPT_FILE" ]]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cat "$PROMPT_FILE"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif [[ -n "$TASK_PROMPT" ]]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "$TASK_PROMPT"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo -e "${RED}Error: No prompt provided${NC}" >&2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                exit 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    build_claude_cmd() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        local cmd="claude"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if [[ -n "$MODEL" ]]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cmd="$cmd --model $MODEL"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cmd="$cmd -p"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "$cmd"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                main() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    local prompt=$(get_prompt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        local claude_cmd=$(build_claude_cmd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo -e "${PURPLE}=== Ralph Wiggum Loop ===${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo -e "Max iterations: ${YELLOW}$MAX_ITERATIONS${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo -e "Completion phrase: ${YELLOW}$COMPLETION_PROMISE${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [[ "$DRY_RUN" == true ]]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo -e "${YELLOW}[DRY RUN]${NC} Would run: $claude_cmd"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cd "$WORKING_DIR"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    local iteration=0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        local start_time=$(date +%s)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo -e "${GREEN}Starting loop...${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                while [[ $iteration -lt $MAX_ITERATIONS ]]; do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        iteration=$((iteration + 1))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                [[ "$VERBOSE" == true ]] && echo -e "${BLUE}--- Iteration $iteration ---${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        local output=$(echo "$prompt" | $claude_cmd 2>&1) || true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "$output"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if echo "$output" | grep -q "$COMPLETION_PROMISE"; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo -e "${GREEN}=== COMPLETE! Iterations: $iteration ===${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sleep 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo -e "${YELLOW}=== Max iterations reached ===${NC}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            exit 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            main
